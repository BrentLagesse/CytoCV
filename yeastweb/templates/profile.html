<!-- Navigation bar -->
{% extends 'base.html' %}
<!-- Template specific content -->
{% block content %}
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Profile</title>
        <style>
            body {
                font-family: var(--app-font);
                background-color: var(--page-bg);
                color: var(--text);
                margin: 0;
                padding: calc(var(--nav-height) + 24px) 24px 40px;
                min-height: 100vh;
            }
            h1, h2 { margin: 0; }
            h1 { font-size: 24px; }
            h2 { font-size: 20px; color: var(--text); }

            .wrapper {
                display: flex;
                flex-wrap: wrap;
                gap: 20px;
                max-width: 1200px;
                margin: 0 auto;
                align-items: flex-start;
            }

            .info,
            .display {
                background-color: var(--card-bg);
                border: 1px solid var(--panel-border);
                border-radius: 16px;
                padding: 24px;
                box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3);
            }
            .info {
                flex: 0 0 260px;
                font-size: 18px;
                text-align: left;
                display: grid;
                gap: 8px;
            }
            .display {
                flex: 1 1 600px;
                display: grid;
                gap: 20px;
            }

            .progress-bar-container {
                width: 100%;
                max-width: 520px;
                height: 22px;
                margin: 0 auto;
                background-color: var(--surface-input);
                border: 1px solid var(--panel-border);
                border-radius: 999px;
                overflow: hidden;
            }
            .progress-bar {
                background-color: var(--accent);
                height: 100%;
                border-radius: 999px;
                display: flex;
                justify-content: center;
                align-items: center;
            }
            .progress-text {
                color: #fff;
                font-size: 12px;
            }

            .files {
                text-align: left;
            }
            .files ul {
                list-style: none;
                padding: 0;
                margin: 12px 0 0;
                display: grid;
                gap: 10px;
            }
            .files li {
                padding: 12px;
                background: var(--surface-muted);
                border: 1px solid var(--panel-border);
                border-radius: 12px;
                display: grid;
                gap: 6px;
            }
            .files a {
                background-color: var(--accent);
                color: #fff;
                text-decoration: none;
                padding: 8px 12px;
                border-radius: 8px;
                width: fit-content;
                transition: background-color 0.3s ease;
                font-size: 14px;
            }
            .files a:hover { background-color: var(--accent-dark); }
            .files p { margin: 0; color: var(--muted); font-size: 13px; }

            .recent {
                background: var(--panel-bg);
                border: 1px solid var(--panel-border);
                border-radius: 16px;
                padding: 20px;
                display: grid;
                gap: 16px;
                align-items: center;
                justify-items: center;
            }

            .main-container {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 100%;
            }
            .main-image {
                width: 100%;
                max-width: 1000px;
                height: 500px;
                border: 1px solid var(--surface-muted);
                border-radius: 12px;
                object-fit: cover;
            }

            .cell-images-row {
                display: flex;
                align-items: stretch;
                justify-content: center;
                width: 100%;
                max-width: 1000px;
                gap: 20px;
                flex-wrap: wrap;
            }
            .cell-id {
                font-size: 16px;
                display: flex;
                align-items: center;
                justify-content: center;
                padding-top: 120px;
                flex-shrink: 0;
            }
            .cell-column {
                display: flex;
                flex-direction: column;
                align-items: center;
                flex-shrink: 0;
            }
            .cell-image {
                width: 200px;
                height: 200px;
                object-fit: contain;
                border: 1px solid var(--surface-muted);
                border-radius: 10px;
                background: var(--surface-media);
            }
            .cell-label {
                width: 200px;
                height: 30px;
                display: flex;
                color: #fff;
                align-items: center;
                justify-content: center;
                text-align: center;
                font-weight: 600;
                margin-bottom: 6px;
                border-radius: 6px;
            }
            .dic { background-color: #000; }
            .dapi { background-color: #1d3ccf; }
            .mcherry { background-color: #d83b3b; }
            .gfp { background-color: #168f4b; }

            .info-box {
                font-size: 13px;
                text-align: center;
                margin-top: 6px;
                color: var(--muted);
            }
            .tight-info {
                line-height: 1.4;
                margin: 0;
            }

            .navigation-buttons {
                margin-top: 8px;
                display: flex;
                justify-content: center;
                gap: 12px;
            }
            .navigation-buttons button {
                padding: 10px 16px;
                font-size: 14px;
                background-color: var(--accent);
                color: #fff;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                transition: background-color 0.3s ease;
            }
            .navigation-buttons button:hover { background-color: var(--accent-dark); }
        </style>
    </head>
    <body>
    <div class="wrapper soft-fade-in">
        <div class="info">
            <p>{{ first_name }} {{ last_name }} </p>
            <p>{{ email }}</p>
        </div>
        {% load bytes_filters %}
        <div class="display">
            <h1>Used Storage</h1>
            <div class="progress-bar-container">
                <div class="progress-bar" style="width: {{ percentage_used }}%;">
                    <span class="progress-text">{{ used_storage|filesize }} / {{ total_storage|filesize }}</span>
                </div>
            </div>
            <p>Storage Available: {{ available_storage|filesize }}</p>
            <div class="files">
                <h1>Your files</h1>
                <ul>
                    {% for image in images %}
                        <li>
                            <a href="/image/{{ image.id }}/display/">{{ image.name }}</a>
                            <p>Uploaded date {{ image.date }} UTC</p>
                            <p>Cell Pairs: {{ image.cell }}</p>
                        </li>
                        {% empty %}
                        <li>No images available.</li>
                    {% endfor %}
                </ul>
            </div>
            <div class="recent">
                <h1>Recent files</h1>
                <!-- Main Image and Title -->
                <h2 id="imageTitle">{{ Image_Name }}</h2>
                <div class="main-container">
                    <img id="mainImage" class="main-image" src="{{ MainImagePath }}" alt="Main Image">
                </div>

                <!-- Cell Images Row with Cell ID on Same Line -->
                <div class="cell-images-row">
                    <div class="cell-id">Cell ID:<span id="cellID" style="margin-left: 4px;">1</span></div>

                    <!-- DIC cell image -->
                    <div class="cell-column">
                        <div class="cell-label dic">DIC</div>
                        <img id="cellImage1" class="cell-image" src="">
                    </div>

                    <!-- DAPI cell image -->
                    <div class="cell-column">
                        <div class="cell-label dapi">DAPI</div>
                        <img id="cellImage2" class="cell-image" src="">
                        <div class="info-box">
                            <div class="tight-info">Nucleus intensity from DAPI: <span
                                    id="nucleusIntensitySum_DAPI"></span></div>
                            <div class="tight-info">Total cellular intensity from DAPI: <span
                                    id="cellularIntensitySum_DAPI"></span></div>
                            <div class="tight-info">Cytoplasmic intensity from DAPI: <span
                                    id="cytoplasmicIntensity_DAPI"></span></div>
                        </div>
                    </div>

                    <!-- mCherry cell image with additional info -->
                    <div class="cell-column">
                        <div class="cell-label mcherry">mCherry</div>
                        <img id="cellImage3" class="cell-image" src="">
                        <div class="info-box">
                            <div class="tight-info">MCherry Line Distance: <span id="distance"></span></div>
                            <div class="tight-info">Line GFP Intensity: <span id="lineGFPIntensity"></span></div>
                            <div class="tight-info">Green Red Intensity: <span id="greenredIntensity"></span></div>
                        </div>
                    </div>

                    <!-- GFP cell image with additional info -->
                    <div class="cell-column">
                        <div class="cell-label gfp">GFP</div>
                        <img id="cellImage4" class="cell-image" src="">
                        <div class="info-box">
                            <div class="tight-info">Nucleus Intensity Sum: <span id="nucleusIntensitySum"></span></div>
                            <div class="tight-info">Cellular Intensity Sum: <span id="cellularIntensitySum"></span>
                            </div>
                            <div class="tight-info">Cytoplasmic Intensity: <span id="cytoplasmicIntensity"></span></div>
                            <div class="tight-info">GFP Dot: <span id="gfpDot"></span></div>
                            <div class="tight-info">Biorientation: <span id="biorientation"></span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Navigation Buttons for Cells -->
                <div class="navigation-buttons">
                    <button onclick="previousCell()">Previous Cell</button>
                    <button onclick="nextCell()">Next Cell</button>
                </div>

                <script>
                    let filesData = JSON.parse('{{ files_data|safe }}');  // Get all the file data (multiple UUIDs)
                    let fileUUIDs = Object.keys(filesData);  // Extract all UUIDs (the list of file UUIDs)
                    let currentFileIndex = 0;  // Initialize the first file
                    let currentCellNumber = 1;
                    let maxCells;

                    // Load the first file on page load
                    window.onload = function () {
                        loadFile(currentFileIndex);  // Load the first file
                    };

                    // Function to load a file (UUID) and display its images
                    function loadFile(fileIndex) {
                        const fileUUID = fileUUIDs[fileIndex];
                        const fileData = filesData[fileUUID];

                        // Update the main image and cell images
                        document.getElementById("mainImage").src = fileData.MainImagePath;
                        document.getElementById("imageTitle").textContent = fileData.Image_Name;

                        // Load the first cell images for the current file
                        maxCells = Number(fileData.NumberOfCells);
                        currentCellNumber = 1;  // Reset to the first cell when changing files
                        updateCellImages(fileData.CellPairImages, fileData.Statistics);
                    }

                    // Function to update the images and statistics for the current cell
                    function updateCellImages(cellPairImages, statistics) {
                        const imageUrls = cellPairImages[currentCellNumber];
                        document.getElementById("cellImage1").src = imageUrls[0];
                        document.getElementById("cellImage1_2").src = imageUrls[1];
                        document.getElementById("cellImage2").src = imageUrls[2];
                        document.getElementById("cellImage2_2").src = imageUrls[3];
                        document.getElementById("cellImage3").src = imageUrls[4];
                        document.getElementById("cellImage3_2").src = imageUrls[5];
                        document.getElementById("cellImage4").src = imageUrls[6];
                        document.getElementById("cellImage4_2").src = imageUrls[7];
                        document.getElementById("cellID").textContent = currentCellNumber;

                        // Update the statistics for the current cell
                        const cellStats = statistics[currentCellNumber];
                        const categories = ['One green dot with each red dot', 'One green dot with one red dot', 'Two green dots with one red dot', 'N/A'];
                        const category = cellStats ? categories[cellStats.category_GFP_dot - 1] : 'N/A';

                        document.getElementById("distance").textContent = cellStats ? cellStats.distance : "N/A";
                        document.getElementById("lineGFPIntensity").textContent = cellStats ? cellStats.line_gfp_intensity : "N/A";
                        document.getElementById("greenredIntensity").textContent = cellStats ? cellStats.green_red_intensity : "N/A";
                        document.getElementById("nucleusIntensitySum").textContent = cellStats ? cellStats.nucleus_intensity_sum : "N/A";
                        document.getElementById("cellularIntensitySum").textContent = cellStats ? cellStats.cellular_intensity_sum : "N/A";
                        document.getElementById("cytoplasmicIntensity").textContent = cellStats ? cellStats.cytoplasmic_intensity : "N/A";
                        document.getElementById("gfpDot").textContent = category;
                        document.getElementById("biorientation").textContent = cellStats ? cellStats.biorientation : "N/A";
                        document.getElementById("nucleusIntensitySum_DAPI").textContent = cellStats ? cellStats.nucleus_intensity_sum_DAPI : "N/A";
                        document.getElementById("cytoplasmicIntensity_DAPI").textContent = cellStats ? cellStats.cytoplasmic_intensity_DAPI : "N/A";
                        document.getElementById("cellularIntensitySum_DAPI").textContent = cellStats ? cellStats.cellular_intensity_sum_DAPI : "N/A";
                    }

                    // Function to load the next main image (file) without page reload
                    function nextFile() {
                        currentFileIndex = (currentFileIndex) % fileUUIDs.length;
                        loadFile(currentFileIndex);  // Dynamically update images for the next file
                    }

                    // Function to load the previous main image (file) without page reload
                    function previousFile() {
                        currentFileIndex = (currentFileIndex - 1 + fileUUIDs.length) % fileUUIDs.length;
                        loadFile(currentFileIndex);  // Dynamically update images for the previous file
                    }

                    // Function to load the next set of cell images without page reload
                    function nextCell() {
                        currentCellNumber = (currentCellNumber % maxCells) + 1;
                        const fileData = filesData[fileUUIDs[currentFileIndex]];
                        updateCellImages(fileData.CellPairImages, fileData.Statistics);
                    }

                    // Function to load the previous set of cell images without page reload
                    function previousCell() {
                        currentCellNumber = (currentCellNumber - 1 > 0) ? (currentCellNumber - 1) : maxCells;
                        const fileData = filesData[fileUUIDs[currentFileIndex]];
                        updateCellImages(fileData.CellPairImages, fileData.Statistics);
                    }
                </script>
            </div>
        </div>
    </div>
    </body>
    </html>
{% endblock content %}
